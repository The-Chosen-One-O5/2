<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Session Timer | Palette</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #000000;
            --bg-container: #1c1c1e; /* Very dark grey, slightly off-black */

            --color-rose-taupe: #785964;
            --color-cambridge-blue: #82A7A6;
            --color-sky-blue: #9ED0E6;
            --color-rose-quartz: #B796AC;

            --primary-text-color: var(--color-rose-quartz); /* For general text */
            --heading-color: var(--color-sky-blue);
            --timer-color: var(--color-sky-blue);
            --phase-loop-text-color: var(--color-cambridge-blue);


            --button-bg-default: var(--color-cambridge-blue);
            --button-text-default: #000000; /* Black text for contrast */
            --button-bg-default-hover: #9bc4c3; /* Lighter Cambridge Blue */

            --button-bg-start: var(--color-rose-taupe);
            --button-text-start: var(--color-sky-blue);
            --button-bg-start-hover: #8c6f7c; /* Lighter Rose Taupe */
            
            --button-bg-other: var(--color-rose-quartz); /* For back/stop buttons */
            --button-text-other: #000000;
            --button-bg-other-hover: #c9a8bd; /* Lighter Rose Quartz */


            --input-border-color: var(--color-cambridge-blue);
            --input-text-color: var(--color-sky-blue);
            --input-bg-color: #101010; /* Darker than container for input bg */

            --fullscreen-text-color: #FFFFFF; 

            --font-pixel: 'Press Start 2P', cursive;
        }

        body {
            font-family: var(--font-pixel);
            background-color: var(--bg-body);
            color: var(--primary-text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            overflow-x: hidden;
        }

        #app-container {
            background-color: var(--bg-container);
            padding: 30px 40px;
            border-radius: 15px; /* Slightly less rounded */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); /* Simple shadow, no glow */
            width: 90%;
            max-width: 650px;
            border: 2px solid var(--color-rose-taupe); /* Use one of the palette colors for border */
            position: relative; 
        }
        
        .screen {
            opacity: 1;
            transform: scale(1);
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
            width: 100%; 
        }
        .screen.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none; 
            position: absolute; 
            top: 0;
            left: 0;
        }

        h1, h2 {
            color: var(--heading-color);
            text-shadow: none; /* Removed glow */
            margin-bottom: 25px;
        }
        h1 { font-size: 1.8em; }
        h2 { font-size: 1.5em; }

        button {
            font-family: var(--font-pixel);
            color: var(--button-text-default); /* Default text color */
            background-color: var(--button-bg-default); /* Default background */
            border: none;
            padding: 15px 25px; 
            margin: 10px 5px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.15s, box-shadow 0.2s;
            font-size: 0.9em;
            letter-spacing: 1px;
            box-shadow: 0 3px 5px rgba(0,0,0,0.25); /* Simpler shadow */
            text-shadow: none; /* Removed text glow from button */
        }

        button:hover {
            background-color: var(--button-bg-default-hover);
            transform: translateY(-2px);
            box-shadow: 0 5px 8px rgba(0,0,0,0.3);
        }
        
        button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 3px rgba(0,0,0,0.3);
        }

        button:disabled {
            background-color: #444; /* Darker grey for disabled */
            color: #888;
            cursor: not-allowed;
            box-shadow: 0 3px 5px rgba(0,0,0,0.15);
            transform: translateY(0);
        }
        
        /* Specific button styles */
        #start-button {
            background-color: var(--button-bg-start);
            color: var(--button-text-start);
        }
        #start-button:hover {
            background-color: var(--button-bg-start-hover);
        }

        #back-to-session-select, #stop-button, #pause-resume-button {
             background-color: var(--button-bg-other);
             color: var(--button-text-other);
        }
        #back-to-session-select:hover, #stop-button:hover, #pause-resume-button:hover {
            background-color: var(--button-bg-other-hover);
        }


        input[type="number"] {
            font-family: var(--font-pixel);
            padding: 12px;
            margin: 15px 0;
            border-radius: 8px;
            border: 2px solid var(--input-border-color);
            background-color: var(--input-bg-color);
            color: var(--input-text-color);
            width: 100px;
            text-align: center;
            font-size: 1em;
            box-shadow: inset 0 0 5px rgba(0,0,0, 0.2); /* Subtle inset shadow */
        }

        #session-options button {
            display: inline-block;
            width: calc(50% - 24px); 
            margin: 12px;
        }
        
        @media (max-width: 600px) {
            #session-options button {
                width: calc(100% - 24px); 
            }
            h1 { font-size: 1.5em; }
        }

        #timer-display {
            font-size: 4em; 
            margin: 25px 0;
            color: var(--timer-color);
            text-shadow: none; /* Removed glow */
            /* animation: pulseTimer 1.5s infinite alternate ease-in-out; */ /* Removed pulse animation as per "no glow" */
        }
        /* Removed pulseTimer keyframes */

        #current-phase-display, #current-loop-display {
            font-size: 1.3em;
            margin-bottom: 12px;
            color: var(--phase-loop-text-color);
            text-shadow: none; /* Removed glow */
        }

        #fullscreen-message-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 1); /* Pure black overlay */
            display: none; 
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            color: var(--fullscreen-text-color);
            padding: 20px;
            box-sizing: border-box;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #fullscreen-message-overlay.visible {
            display: flex;
            opacity: 1;
        }

        #fullscreen-text {
            font-size: 2em; 
            max-width: 80%;
            line-height: 1.6;
            text-shadow: none; /* Removed glow */
        }
        @media (max-width: 768px) {
            #fullscreen-text {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <div id="initial-screen" class="screen">
            <h1>Focus Session Timer</h1>
            <p>Select session duration:</p>
            <div id="session-options">
                <!-- Session buttons populated by JS -->
            </div>
        </div>

        <div id="loop-selection" class="screen hidden">
            <h2>Configure Loops</h2>
            <label for="loop-count">Number of Loops (1-50):</label><br>
            <input type="number" id="loop-count" min="1" max="50" value="1"><br>
            <button id="start-button">Start Full Session</button>
            <button id="back-to-session-select">Change Session</button>
        </div>

        <div id="timer-screen" class="screen hidden">
            <h2 id="current-phase-display">Phase</h2>
            <div id="timer-display">00:00</div>
            <div id="current-loop-display">Loop 0/0</div>
            <div>
                <button id="pause-resume-button">Pause</button>
                <button id="stop-button">Stop Session</button>
            </div>
        </div>
    </div>

    <div id="fullscreen-message-overlay">
        <p id="fullscreen-text"></p>
    </div>

    <!-- Audio Elements -->
    <audio id="audio-get-ready" loop src="https://www.dropbox.com/scl/fi/hrbitky0j4l92zya0gvrg/If-You-re-A-Gamer-This-Song-FOUND-You-4.mp3?rlkey=4kevn083g6iz20bcmh5o6kizw&st=c6pto1qp&dl=1"></audio>
    <audio id="audio-session-music" loop></audio>
    <audio id="audio-break-music" loop></audio>
    <audio id="audio-break-over" src="https://www.dropbox.com/scl/fi/8gwxrqbx5ym1mtpsq3wjp/ElevenLabs_2025-05-16T05_11_55_Viraj-Dramatic-TV-Narration_pvc_sp87_s32_sb17_se0_b_m2.mp3?rlkey=9swp716gchv924ydsdn8sqpw9&st=hjd21l4p&dl=1"></audio>
    <audio id="audio-break-start" src="https://www.dropbox.com/scl/fi/tnukseo2zksmyo1nnbv55/ElevenLabs_2025-05-16T05_13_43_Viraj-Dramatic-TV-Narration_pvc_sp100_s32_sb17_se0_b_m2.mp3?rlkey=aycq7ribjhv9sdrth5gilthxa&st=23v3h1su&dl=1"></audio>

    <script>
        // --- DOM Elements ---
        const initialScreen = document.getElementById('initial-screen');
        const sessionOptionsContainer = document.getElementById('session-options');
        const loopSelectionScreen = document.getElementById('loop-selection');
        const loopCountInput = document.getElementById('loop-count');
        const startButton = document.getElementById('start-button');
        const backToSessionSelectButton = document.getElementById('back-to-session-select');

        const timerScreen = document.getElementById('timer-screen');
        const currentPhaseDisplay = document.getElementById('current-phase-display');
        const timerDisplay = document.getElementById('timer-display');
        const currentLoopDisplay = document.getElementById('current-loop-display');
        const pauseResumeButton = document.getElementById('pause-resume-button');
        const stopButton = document.getElementById('stop-button');

        const fullscreenMessageOverlay = document.getElementById('fullscreen-message-overlay');
        const fullscreenText = document.getElementById('fullscreen-text');

        // --- Audio Elements & URLs ---
        const audioElements = {
            getReady: document.getElementById('audio-get-ready'),
            sessionMusic: document.getElementById('audio-session-music'),
            breakMusic: document.getElementById('audio-break-music'),
            breakOver: document.getElementById('audio-break-over'),
            breakStart: document.getElementById('audio-break-start')
        };
        const sessionMusicTracks = [
            "https://www.dropbox.com/scl/fi/5uqsgnjokpxhhaofkmx2g/chillcraft.mp3?rlkey=3l25hd8k4h8renrm2j3josvgp&st=ygtc6cxk&dl=1",
            "https://www.dropbox.com/scl/fi/6gl1bhdz9pe8ymjyh0jgd/RevenantEntertainment-kataruma-dont-worry-ill-always-be-here-for-you.mp3?rlkey=ntodkwanh7by2r2nyuw7cht1x&st=z5o2ehqe&dl=1",
            "https://www.dropbox.com/scl/fi/6gbti0c7ka2e3lc1kj895/Toxic-Drunker-a-playlist-to-romanticize-studying-physics-dark-academia-playlist.mp3?rlkey=xfo51y00j6tbuozey81c5cfub&st=1m54zf7k&dl=1"
        ];
        const breakMusicTracks = [
            "https://www.dropbox.com/scl/fi/tamjmugo9ie0r0nar0ozr/Molls-Inc.-Fallen-Down-Reprise-but-I-recorded-it-off-real-8-bit-hardware-from-1983-and-makes-me-feel-nostalgic.mp3?rlkey=sam1dussjmf5jq4zlxj0hpe9r&st=bb4dos63&dl=1",
            "https://www.dropbox.com/scl/fi/nqgmray2um9mjtm9stjk9/aria_math_credit_to_c4.mp3?rlkey=99e4kgsulvy1k738piy17iiye&st=aohxn24c&dl=1"
        ];
        let currentSessionMusicIndex = 0;
        let currentBreakMusicIndex = 0;

        // --- State Variables ---
        let selectedSessionMinutes = 0;
        let totalLoops = 0;
        let currentLoopNumber = 0;
        let currentPhase = 'idle';
        let timeLeftSeconds = 0;
        let timerInterval = null;
        let isPaused = false;

        // --- Constants ---
        const GET_READY_DURATION_SECONDS = 5 * 60;
        const BREAK_DURATION_SECONDS = 15 * 60;
        // const GET_READY_DURATION_SECONDS = 3; // Test
        // const BREAK_DURATION_SECONDS = 4; // Test
        const TYPEWRITER_SPEED = 70; 

        const sessionDefinitions = [
            { label: "30 Mins", duration: 30 }, { label: "40 Mins", duration: 40 },
            { label: "50 Mins", duration: 50 }, { label: "1 Hour", duration: 60 },
            { label: "1.5 Hrs", duration: 90 }, { label: "2 Hrs", duration: 120 },
            { label: "2.5 Hrs", duration: 150 }
        ];

        // --- Screen Management ---
        function showScreen(screenElement) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            screenElement.classList.remove('hidden');
        }
        
        // --- Initialization ---
        function init() {
            populateSessionButtons();
            startButton.addEventListener('click', handleStartFullSession);
            backToSessionSelectButton.addEventListener('click', () => {
                handleStopSession(); // Ensure state is reset if going back
                showScreen(initialScreen);
            });
            pauseResumeButton.addEventListener('click', togglePauseResume);
            stopButton.addEventListener('click', handleStopSession);

            audioElements.breakOver.preload = "auto";
            audioElements.breakStart.preload = "auto";
            audioElements.getReady.preload = "auto";

            showScreen(initialScreen); 
        }

        function populateSessionButtons() {
            sessionOptionsContainer.innerHTML = '';
            sessionDefinitions.forEach(session => {
                const button = document.createElement('button');
                button.textContent = session.label;
                button.dataset.duration = session.duration;
                button.addEventListener('click', () => selectSession(session.duration));
                sessionOptionsContainer.appendChild(button);
            });
        }

        function selectSession(duration) {
            selectedSessionMinutes = duration;
            showScreen(loopSelectionScreen);
            loopCountInput.focus();
        }

        function goFullScreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen().catch(err => {});
            } else if (elem.mozRequestFullScreen) { elem.mozRequestFullScreen();
            } else if (elem.webkitRequestFullscreen) { elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) { elem.msRequestFullscreen(); }
        }
        
        function exitFullScreen() {
            if (document.exitFullscreen) { document.exitFullscreen();
            } else if (document.mozCancelFullScreen) { document.mozCancelFullScreen();
            } else if (document.webkitExitFullscreen) { document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) { document.msExitFullscreen(); }
        }

        // --- Main Flow Control ---
        function handleStartFullSession() {
            const loops = parseInt(loopCountInput.value);
            if (isNaN(loops) || loops < 1 || loops > 50) {
                alert("Please enter a valid number of loops (1-50).");
                return;
            }
            totalLoops = loops;
            currentLoopNumber = 0;
            isPaused = false;
            pauseResumeButton.textContent = "Pause";

            goFullScreen(); 
            showScreen(timerScreen);
            startGetReadyPhase();
        }

        function startGetReadyPhase() {
            currentPhase = 'getReady';
            timeLeftSeconds = GET_READY_DURATION_SECONDS;
            updatePhaseDisplay("Get Ready");
            updateLoopDisplay();
            stopAllBackgroundMusic();
            playAudio(audioElements.getReady);
            startTimer(onGetReadyEnd);
        }

        function onGetReadyEnd() {
            stopAudio(audioElements.getReady);
            startNextLoopCycle();
        }

        function startNextLoopCycle() {
            currentLoopNumber++;
            if (currentLoopNumber > totalLoops) {
                finishEntireSession();
                return;
            }
            updateLoopDisplay();
            startPomodoroPhase();
        }

        function startPomodoroPhase() {
            currentPhase = 'pomodoro';
            timeLeftSeconds = selectedSessionMinutes * 60;
            // timeLeftSeconds = 5; // Test
            updatePhaseDisplay(`Session ${currentLoopNumber}`);
            stopAllBackgroundMusic();
            playSessionMusic();
            startTimer(onPomodoroEnd);
        }

        function onPomodoroEnd() {
            stopAudio(audioElements.sessionMusic);
            if (currentLoopNumber <= totalLoops) { // Check if it's the last loop or not
                 showBreakStartMessage();
            }
            // If it was the last pomodoro of the last loop, finishEntireSession will be called by startNextLoopCycle
        }

        function showBreakStartMessage() {
            currentPhase = 'message';
            updatePhaseDisplay("Break Incoming");
            playAudio(audioElements.breakStart);
            showFullScreenMessageView("Break Time! Have some rest.", () => {});
            audioElements.breakStart.onended = () => {
                hideFullScreenMessageView();
                startBreakPhase();
            };
        }

        function startBreakPhase() {
            currentPhase = 'break';
            timeLeftSeconds = BREAK_DURATION_SECONDS;
            updatePhaseDisplay("Break Time");
            stopAllBackgroundMusic();
            playBreakMusic();
            startTimer(onBreakEnd);
        }

        function onBreakEnd() {
            stopAudio(audioElements.breakMusic);
            if (currentLoopNumber >= totalLoops) { // If this break was after the last pomodoro
                finishEntireSession();
            } else {
                showBreakOverMessage();
            }
        }
        
        function showBreakOverMessage() {
            currentPhase = 'message';
            updatePhaseDisplay("Work Incoming");
            playAudio(audioElements.breakOver);
            showFullScreenMessageView("Break is over. Get back to study!", () => {});
             audioElements.breakOver.onended = () => {
                hideFullScreenMessageView();
                startNextLoopCycle(); // This will increment loop and start next pomodoro
            };
        }

        function finishEntireSession() {
            currentPhase = 'idle';
            stopAllAudio();
            updateTimerDisplayValue(0);
            updatePhaseDisplay("Session Complete!");
            currentLoopDisplay.textContent = "All loops finished!";
            showFullScreenMessageView("Congratulations! Session Complete!", () => {
                setTimeout(() => {
                    hideFullScreenMessageView();
                    showScreen(initialScreen);
                    exitFullScreen(); 
                }, 3000);
            });
        }

        function handleStopSession() {
            clearInterval(timerInterval);
            timerInterval = null;
            currentPhase = 'idle';
            isPaused = false;
            stopAllAudio();
            hideFullScreenMessageView(); 
            showScreen(initialScreen); // Always go back to initial screen on stop
            if (document.fullscreenElement) { // Only exit if in fullscreen
                 exitFullScreen();
            }
            updateTimerDisplayValue(0);
            currentPhaseDisplay.textContent = "Session Timer"; // Reset default title
            currentLoopDisplay.textContent = "";
            selectedSessionMinutes = 0; // Reset selection
            totalLoops = 0;
            currentLoopNumber = 0;
        }

        // --- Timer Logic ---
        function startTimer(onEndCallback) {
            clearInterval(timerInterval);
            isPaused = false;
            pauseResumeButton.textContent = "Pause";
            pauseResumeButton.disabled = false;
            updateTimerDisplay(); 

            timerInterval = setInterval(() => {
                if (isPaused) return;
                timeLeftSeconds--;
                updateTimerDisplay();
                if (timeLeftSeconds <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    if (onEndCallback) onEndCallback();
                }
            }, 1000);
        }

        function togglePauseResume() {
            if (currentPhase === 'message' || currentPhase === 'idle') return; // Don't allow pause during messages

            if (isPaused) {
                isPaused = false;
                pauseResumeButton.textContent = "Pause";
                if (currentPhase === 'getReady' && audioElements.getReady.paused) playAudio(audioElements.getReady, true);
                else if (currentPhase === 'pomodoro' && audioElements.sessionMusic.paused) playAudio(audioElements.sessionMusic, true);
                else if (currentPhase === 'break' && audioElements.breakMusic.paused) playAudio(audioElements.breakMusic, true);
            } else {
                isPaused = true;
                pauseResumeButton.textContent = "Resume";
                if (currentPhase === 'getReady') audioElements.getReady.pause();
                else if (currentPhase === 'pomodoro') audioElements.sessionMusic.pause();
                else if (currentPhase === 'break') audioElements.breakMusic.pause();
            }
        }
        
        // --- UI Updates ---
        function updateTimerDisplay() {
            updateTimerDisplayValue(timeLeftSeconds);
        }
        function updateTimerDisplayValue(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            const timeString = `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
            timerDisplay.textContent = timeString;
            document.title = `${timeString} - ${currentPhaseDisplay.textContent}`;
        }

        function updatePhaseDisplay(phaseText) {
            currentPhaseDisplay.textContent = phaseText;
        }

        function updateLoopDisplay() {
            if (totalLoops > 0 && currentPhase !== 'getReady' && currentLoopNumber > 0) {
                 currentLoopDisplay.textContent = `Loop: ${currentLoopNumber} / ${totalLoops}`;
            } else if (currentPhase === 'getReady' && totalLoops > 0) {
                 currentLoopDisplay.textContent = `Preparing for ${totalLoops} loop(s)`;
            } else {
                currentLoopDisplay.textContent = "";
            }
        }

        function showFullScreenMessageView(text, typewriterCallback) {
            fullscreenText.textContent = ''; 
            fullscreenMessageOverlay.classList.add('visible');
            typeWriterEffect(fullscreenText, text, TYPEWRITER_SPEED, typewriterCallback);
        }

        function hideFullScreenMessageView() {
            fullscreenMessageOverlay.classList.remove('visible');
            setTimeout(() => { fullscreenText.textContent = ''; }, 500); 
        }

        function typeWriterEffect(element, text, speed, callback) {
            let i = 0;
            element.innerHTML = ""; 
            function type() {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                } else if (callback) {
                    callback();
                }
            }
            type();
        }

        // --- Audio Control ---
        function playAudio(audioElement, resume = false) { // Added resume flag
            if (audioElement) {
                if(!resume) audioElement.currentTime = 0; // Only reset time if not resuming
                audioElement.play().catch(error => {
                    if (error.name === "NotAllowedError") {
                        console.warn("Audio autoplay was prevented.");
                    } else { console.error("Audio play error:", error); }
                });
            }
        }
        function stopAudio(audioElement) {
            if (audioElement) { audioElement.pause(); audioElement.currentTime = 0; }
        }
        function stopAllBackgroundMusic() {
            stopAudio(audioElements.getReady);
            stopAudio(audioElements.sessionMusic);
            stopAudio(audioElements.breakMusic);
        }
        function stopAllAudio() {
            stopAllBackgroundMusic();
            stopAudio(audioElements.breakStart);
            stopAudio(audioElements.breakOver);
        }
        function playSessionMusic() {
            if (sessionMusicTracks.length > 0) {
                audioElements.sessionMusic.src = sessionMusicTracks[currentSessionMusicIndex];
                playAudio(audioElements.sessionMusic);
                currentSessionMusicIndex = (currentSessionMusicIndex + 1) % sessionMusicTracks.length;
            }
        }
        function playBreakMusic() {
            if (breakMusicTracks.length > 0) {
                audioElements.breakMusic.src = breakMusicTracks[currentBreakMusicIndex];
                playAudio(audioElements.breakMusic);
                currentBreakMusicIndex = (currentBreakMusicIndex + 1) % breakMusicTracks.length;
            }
        }

        // --- Start the app ---
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
